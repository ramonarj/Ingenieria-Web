<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1" name="viewport" />
	<title>Firefighter Space</title>
	<link rel="stylesheet" th:href="@{/css/toolbar.css}" href="../static/css/toolbar.css" type="text/css"/> 
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" 
	rel="stylesheet">
	<script>
		const ff = {
			socketUrl: '[[${session.ws}?:false]]',
			voteApiUrl: '[[${session.ws}?@{/api/v/}:false]]',
			csrf: {
				name: "[[${_csrf.parameterName}]]",
				value: "[[${_csrf.token}]]"
			},
			admin: [[${session.u != null && session.u.hasRole('admin')}?'true':'false']],
			userId: [[${session.u != null}?${session.u.id}:-1]]
		};
		
		/**
		 * WebSocket API, which only works once initialized
		 */
		const ws = {
				
			/**
			 * WebSocket, or null if none connected
			 */
			socket: null,
			
			/**
			 * Sends a string to the server via the websocket.
			 * @param {string} text to send 
			 * @returns nothing
			 */
			send: (text) => {
				if (ws.socket != null) {
					ws.socket.send(text);
				}
			},

			/**
			 * Default action when text is received. 
			 * @returns
			 */
			receive: (text) => {
				console.log(text);
			},
			
			/**
			 * Attempts to establish communication with the specified
			 * web-socket endpoint. If successfull, will call 
			 * @returns
			 */
			initialize: (endpoint) => {
				try {
					ws.socket = new WebSocket(endpoint);
					ws.socket.onmessage = (e) => ws.receive(e.data);
					console.log("Connected to WS '" + endpoint + "'")
				} catch (e) {
					console.log("Error, connection to WS '" + endpoint + "' FAILED: ", e);
				}
			}
		} 
		
		window.addEventListener('load', () => {
			if (ff.socketUrl !== false) {
				ws.initialize(ff.socketUrl);
			}
		});
	</script>
</head>
<body>
	<div class="bg-image"></div>
	<header>
		<div class="avatar">
		<img th:src="@{/user/{id}/perfil/photo(id=${user.id})}" alt="Foto de perfil">
		</div>
		<div class="menu-toggle"></div>
		<nav>
			<ul>
				<li th:if="${session.u.hasRole('admin')}">
					<form th:action = "@{/admin/} + ${user.id}" method="get">
					<button type="submit" id=""><a>AÃ±adir Bomberos</a></button>
					</form>
				</li>
				<li>
					<form th:action = "@{/user/} + ${user.id} + '/horario'" method="get">
					<button type="submit"><a>Horario</a></button>
					</form>
				</li>
				<li>
					<form th:action = "@{/user/} + ${user.id} + '/equipo'" method="get">
					<button type="submit"><a>Equipo</a></button>
					</form>
				</li>
				<li>
					<form th:action = "@{/user/} + ${user.id} + '/chat'" method="get">
					<button type="submit"><a>Chat</a></button>
					</form>
				</li>
				<li>
					<form th:action = "@{/user/} + ${user.id} + '/perfil'" method="get">
					<button type="submit"><a>Perfil</a></button>
					</form>
				</li>
				<li id="exit">
				<form th:action = "@{/logout}" method="POST">
					<button type="submit">
						<a>Salir<i class="fa fa-sign-out" aria-hidden="true"></i></a>
					</button>
				</form>
				</li>
			</ul>
		</nav>
		<div class="clearfix"></div>
	</header>
	<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
	<script src="/js/toolbar.js"></script>
</body>
</html>